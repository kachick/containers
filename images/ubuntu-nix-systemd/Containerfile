FROM public.ecr.aws/ubuntu/ubuntu:24.04_stable@sha256:6b4c0f97bc73e76ac20ef992258e9b8c831b7755d2047d83109da8eb279881fe


LABEL org.opencontainers.image.source=https://github.com/kachick/containers
LABEL org.opencontainers.image.description="Nix package manager on Ubuntu - systemd"
LABEL org.opencontainers.image.licenses=MIT

# Available versions in apt: https://packages.ubuntu.com/noble/curl
# --no-install-recommends omits ca-certificates
RUN apt-get update \
 && apt-get install --no-install-recommends -y curl	ca-certificates \
 systemd \
 git \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

ENV PATH="${PATH}:/nix/var/nix/profiles/default/bin"

# AFAIK, we can not use official installer for this purpose because it does not have options similar to `--no-start-daemon`
# We need to clarify setting `experimental-features = nix-command flakes`. It is different from DeterminateSystems/nix-installer
RUN curl --proto '=https' --tlsv1.2 -sSf -L https://artifacts.nixos.org/experimental-installer | sh -s -- install linux \
  --extra-conf "experimental-features = nix-command flakes" \
  --extra-conf "sandbox = false" \
  --extra-conf "trusted-users = root user" \
  --extra-conf "accept-flake-config = true" \
  --no-start-daemon \
  --no-confirm

# TODO: Consider to extract from this repository
ARG username="user"
RUN useradd --no-log-init --create-home $username

CMD [ "/bin/systemd", "--system" ]
